<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gauge Chart with Plotly.js</title>
    <!-- Load Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://apis.google.com/js/api.js"></script>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #9E9C9B;
        }
        .chart-container {
            margin: 5px;
            padding: 5px;
            background-color: #fff;
            border: 2px solid black;
        }
        .chart-container > div {
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body>

<div class="chart-container">
    <div id="myDiv1"></div> <!-- Container for the Plotly chart -->
</div>

<div class="chart-container">
    <div id="myDiv2"></div> <!-- Container for the Plotly chart -->
</div>

<div class="chart-container">
    <div id="myDiv3"></div> <!-- Container for the Plotly chart -->
</div>

<script>
// API key from the Developer Console
var API_KEY = 'AIzaSyCFvX56uc0WNPz2ZTJhpg7Q2pFOgZxt7-0';

// Array of API discovery doc URLs for APIs used by the application
var DISCOVERY_DOCS = ["https://sheets.googleapis.com/$discovery/rest?version=v4"];

// Authorization scopes required by the API; for Sheets API, use 'https://www.googleapis.com/auth/spreadsheets.readonly'
var SCOPES = 'https://www.googleapis.com/auth/spreadsheets.readonly';

function handleClientLoad() {
    gapi.load('client:auth2', initClient);
}

function initClient() {
    gapi.client.init({
        apiKey: API_KEY,
        discoveryDocs: DISCOVERY_DOCS,
        scope: SCOPES
    }).then(function () {
        // Fetch data from Google Sheets API
        fetchSheetData();
    });
}

function fetchSheetData() {
    gapi.client.sheets.spreadsheets.values.get({
        spreadsheetId: '1Em_4WKvdHbWu5WR2HCkd4JRVFaTsjJsqPHqDPRj8Gxs',
        range: 'Sheet1!A1:D' // Update range as per your sheet structure
    }).then(function(response) {
        var range = response.result;
        if (range.values.length > 0) {
            // Process the fetched data
            processData(range.values);
        } else {
            console.log('No data found.');
        }
    }, function(response) {
        console.log('Error: ' + response.result.error.message);
    });
}

function processData(values) {
    // Extracting required data from the fetched values
    var gaugeValues = [];
    var deltaValues = [];
    var currentValues = [];

    // Process each row of data
    values.forEach(function(row) {
        // Ensure all values are numerical; if not, set them to 0
        var gaugeValue = parseFloat(row[1]); // Column B (index 1)
        var deltaValue = parseFloat(row[2]); // Column C (index 2)
        var currentValue = parseFloat(row[3]); // Column D (index 3)

        // Check if any value is NaN, and handle it
        if (!isNaN(gaugeValue) && !isNaN(deltaValue) && !isNaN(currentValue)) {
            gaugeValues.push(gaugeValue);
            deltaValues.push(deltaValue);
            currentValues.push(currentValue);
        } else {
            console.log('Invalid data found in row: ', row);
        }
    });

    // Create data for Plotly charts
    var data1 = createChartData(gaugeValues[0], deltaValues[0], currentValues[0], "Hours Per Day<br><span style='font-size:0.8em;color:gray'>Higher is Better</span>");
    var data2 = createChartData(gaugeValues[1], deltaValues[1], currentValues[1], "% to Goal<br><span style='font-size:0.8em;color:gray'>Higher is Better</span>");
    var data3 = createChartData(gaugeValues[2], deltaValues[2], currentValues[2], "SVC Policy Dollars<br><span style='font-size:0.8em;color:gray'>Lower is Better</span>");

    // Render the Plotly charts
    Plotly.newPlot('myDiv1', data1);
    Plotly.newPlot('myDiv2', data2);
    Plotly.newPlot('myDiv3', data3);
}

function createChartData(gaugeValue, deltaValue, currentValue, titleText) {
    return [{
        domain: { x: [0, 1], y: [0, 1] },
        value: currentValue,
        title: { text: titleText },
        type: "indicator",
        mode: "gauge+number+delta",
        delta: { reference: deltaValue },
        gauge: {
            axis: { range: [null, 200], tickwidth: 2, tickcolor: "darkblue" },
            bar: { color: "darkblue" },
            steps: [
                { range: [0, deltaValue], color: "lightcoral" },
                { range: [deltaValue, 200], color: "lightgreen" }
            ],
            // Add a threshold line
            threshold: {
                line: { color: "blue", width: 2 },
                value: deltaValue // Set the threshold value to delta value
            }
        }
    }];
}

// Call handleClientLoad when the page is fully loaded
window.onload = handleClientLoad;
</script>

</body>
</html>
